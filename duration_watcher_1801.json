{
  "trigger": { "schedule": { "interval": "5m" } },

  "input": {
    "search": {
      "request": {
        "indices": ["urvesh-index"],
        "body": {
          "size": 0,
          "runtime_mappings": {
            "file_name": {
              "type": "keyword",
              "script": {
                "lang": "painless",
                "source": """
                  def msg = params._source['message'];
                  if (msg == null) return;

                  int pIdx = msg.indexOf('Processing file ');
                  if (pIdx >= 0) {
                    int start = pIdx + 'Processing file '.length();
                    int end = msg.indexOf(' ', start);
                    if (end > start) { emit(msg.substring(start, end)); return; }
                  }

                  int sIdx = msg.indexOf('Successfully processed file ');
                  if (sIdx >= 0) {
                    int lastSlash = msg.lastIndexOf('/');
                    int sourceIdx = msg.indexOf(' source', lastSlash);
                    if (lastSlash >= 0 && sourceIdx > lastSlash) {
                      emit(msg.substring(lastSlash + 1, sourceIdx));
                      return;
                    }
                  }
                """
              }
            }
          },
          "query": {
            "bool": {
              "filter": [
                { "term": { "cls.org": "4444444445" } },
                { "wildcard": { "cls.application.keyword": "my-app*" } },
                { "range": { "@timestamp": { "gte": "now-48h", "lte": "now" } } },
                {
                  "bool": {
                    "should": [
                      { "match_phrase": { "message": "Processing file" } },
                      { "match_phrase": { "message": "Successfully processed file" } }
                    ],
                    "minimum_should_match": 1
                  }
                }
              ]
            }
          },
          "aggs": {
            "by_file": {
              "terms": { "field": "file_name", "size": 200 },
              "aggs": {
                "start": {
                  "filter": { "match_phrase": { "message": "Processing file" } },
                  "aggs": { "start_time": { "min": { "field": "@timestamp" } } }
                },
                "end": {
                  "filter": { "match_phrase": { "message": "Successfully processed file" } },
                  "aggs": { "end_time": { "max": { "field": "@timestamp" } } }
                }
              }
            }
          }
        }
      }
    }
  },

  "condition": {
    "script": {
      "lang": "painless",
      "source": """
        double THRESHOLD_MIN = 30.0;

        for (def b : ctx.payload.aggregations.by_file.buckets) {
          def st = b.start.start_time.value;
          def en = b.end.end_time.value;
          if (st == null || en == null) continue;

          double durMin = (en - st) / 60000.0;
          if (durMin > THRESHOLD_MIN) return true;
        }
        return false;
      """
    }
  },

  "transform": {
    "script": {
      "lang": "painless",
      "source": """
        double THRESHOLD_MIN = 30.0;

        def all = [];
        def slow = [];

        for (def b : ctx.payload.aggregations.by_file.buckets) {
          def st = b.start.start_time.value;
          def en = b.end.end_time.value;
          if (st == null || en == null) continue;

          long durMs = (long)(en - st);
          double durMin = durMs / 60000.0;

          def row = [
            "generatedAt": ctx.execution_time,
            "fileName": b.key,
            "startTime": b.start.start_time.value_as_string,
            "endTime": b.end.end_time.value_as_string,
            "durationMs": durMs,
            "durationMinutes": durMin,
            "thresholdMinutes": THRESHOLD_MIN,
            "org": "4444444445",
            "application": "my-app*"
          ];

          all.add(row);
          if (durMin > THRESHOLD_MIN) slow.add(row);
        }

        return [
          "allResults": all,
          "slowResults": slow,
          "thresholdMinutes": THRESHOLD_MIN
        ];
      """
    }
  },

  "actions": {
    "log_slow_files": {
      "logging": {
        "level": "warn",
        "text": "ALERT: ETL duration exceeded {{ctx.payload.thresholdMinutes}} minutes. Slow files: {{ctx.payload.slowResults}}"
      }
    },
    "index_all_durations": {
      "foreach": "ctx.payload.allResults",
      "index": { "index": "etl-file-duration-index" }
    },
    "index_slow_durations": {
      "foreach": "ctx.payload.slowResults",
      "index": { "index": "etl-file-duration-alerts" }
    }
  }
}
